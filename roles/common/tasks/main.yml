---
# This playbook contains common plays that will be run on all nodes.

####################
# Proxy management #
####################

- name: Config environment proxy
  template: >
    src={{ environment_config_template }}
    dest={{ environment_config_file }}
  sudo: yes

- name: Config apt proxy
  template: >
    src={{ apt_config_template }}
    dest={{ apt_config_file }}
  sudo: yes

- name: Copy cntlm deb on remote
  copy: >
    src={{ deb_cntlm_package }}
    dest=/home/{{ user }}/{{ deb_cntlm_package }}
  
- name: Install cntlm deb
  apt: deb=/home/{{ user }}/{{ deb_cntlm_package }}
  sudo: yes

- name: Setting up cntlm configuration
  template: >
    src={{ cntlm_config_template }}
    dest={{ cntlm_config_file }}
  sudo: yes

- name: Start the cntlm service
  service: >
    name=cntlm
    state=restarted
    enabled=yes
    sleep=3
  sudo: yes


###################
# Time management #
###################

- name: Set local timezone
  copy: >
    content={{ timezone }}
    dest=/etc/timezone
  sudo: yes

- name: Update tzdata
  command: /usr/sbin/dpkg-reconfigure --frontend noninteractive tzdata
  sudo: yes

- name: Install ntp (with apt-get update first)
  apt: name=ntp state=present update_cache=yes
  sudo: yes

- name: Setting up ntp servers configuration
  lineinfile: >
    dest=/etc/ntp.conf
    regexp="{{ item.regexp }}"
    line="{{ item.line }}"
  with_items:
    "{{ ntp_servers }}"
  sudo: yes

- name: Start the ntp service
  service: >
    name=ntp
    state=restarted
    enabled=true
    sleep=3
  sudo: yes


######################
# Apache2 management #
######################

- name: Install apache2
  apt: name=apache2 state=present
  sudo: yes